<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²åŒ–ç‰ˆå¯µç‰©é¤Šæˆ - é›²ç«¯å°å¤¥ä¼´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            overscroll-behavior: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰åˆ·æ–° */
        }
        h1, h2, .font-display { font-family: 'Fredoka', sans-serif; }
        
        /* è‡ªå®šç¾©æ¨£å¼ */
        .game-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
        }
        
        .progress-bar-container {
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.5s;
            background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }

        /* å‹•ç•«ç‰¹æ•ˆ */
        @keyframes bounce-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-gentle { animation: bounce-gentle 2s infinite ease-in-out; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s ease-out; }

        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.2); } }
        .float-text { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1.5s forwards; z-index: 50; text-shadow: 1px 1px 0 #fff; }

        /* å°éŠæˆ²å€åŸŸ */
        #miniGameArea {
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .falling-item {
            position: absolute;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .falling-item:active { transform: scale(1.5); filter: brightness(1.2); }

        /* Toast é€šçŸ¥ */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(30, 41, 59, 0.9); color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; text-align: center; animation: fadeInOut 3s forwards; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(20px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }
    </style>
</head>
<body class="text-gray-800 selection:bg-indigo-100">

    <div class="min-h-screen flex items-center justify-center p-4">
        
        <div id="petSelectionPanel" class="game-card w-full max-w-lg p-8 rounded-3xl shadow-xl border border-white/50">
            <h1 class="text-3xl font-display font-bold text-center mb-2 text-indigo-600">é¸æ“‡ä½ çš„å¤¥ä¼´</h1>
            <p class="text-center text-gray-500 mb-8">ä¸€æ—¦é¸æ“‡å°±ä¸èƒ½æ›´æ›å›‰ï¼ˆé™¤éé‡ç½®å­˜æª”ï¼‰</p>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4" id="petSelectGrid">
                </div>
            <div class="mt-8 text-center">
                <button id="resetSaveBtn" class="text-xs text-gray-400 underline hover:text-red-400">é‡ç½®æ‰€æœ‰å­˜æª”</button>
            </div>
        </div>

        <div id="gamePanel" class="hidden w-full max-w-lg">
            <div class="game-card rounded-3xl shadow-2xl overflow-hidden border border-white/60">
                
                <div class="bg-indigo-50/50 p-6 pb-2">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 id="petNameDisplay" class="text-2xl font-bold text-gray-800"></h2>
                            <span id="petLevelDisplay" class="text-xs font-bold bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full">Lv.1</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center text-amber-500 font-bold text-lg bg-white px-3 py-1 rounded-full shadow-sm mb-1">
                                <span class="mr-1">ğŸª™</span> <span id="goldCoinDisplay">0</span>
                            </div>
                            <button id="saveBtn" class="text-xs text-gray-400 hover:text-indigo-500 transition-colors">è‡ªå‹•å­˜æª”ä¸­...</button>
                        </div>
                    </div>
                    
                    <div class="relative w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div id="expFill" class="absolute top-0 left-0 h-full bg-yellow-400 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="text-right text-xs text-gray-400 mt-1"><span id="expValue">0/100</span> XP</div>
                </div>

                <div class="relative h-64 bg-gradient-to-b from-blue-50 to-indigo-50 flex items-center justify-center overflow-hidden group">
                    <div id="decorationContainer" class="absolute inset-0 pointer-events-none"></div>
                    
                    <div id="petHouse" class="relative z-10 text-center cursor-pointer transition-transform active:scale-95 select-none">
                        <div id="petCostume" class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl z-20 pointer-events-none"></div>
                        <div id="petDisplay" class="text-9xl filter drop-shadow-xl animate-bounce-gentle transform transition-transform duration-300"></div>
                        <div id="dirtDisplay" class="absolute bottom-0 right-0 text-5xl animate-pulse hidden z-20">ğŸ’©</div>
                    </div>

                    <div id="floatingTextContainer" class="absolute inset-0 pointer-events-none z-50"></div>
                </div>

                <div class="p-6 space-y-4 bg-white">
                    <div class="grid grid-cols-1 gap-3">
                        <div class="flex items-center gap-3">
                            <span class="text-xl w-8">ğŸ—</span>
                            <div class="flex-1">
                                <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1"><span>é£½è¶³æ„Ÿ</span><span id="hungerValue">100%</span></div>
                                <div class="progress-bar-container h-3"><div id="hungerFill" class="progress-fill bg-green-500" style="width: 100%"></div></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xl w-8">ğŸ’–</span>
                            <div class="flex-1">
                                <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1"><span>å¿«æ¨‚åº¦</span><span id="happinessValue">100%</span></div>
                                <div class="progress-bar-container h-3"><div id="happinessFill" class="progress-fill bg-pink-500" style="width: 100%"></div></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xl w-8">âœ¨</span>
                            <div class="flex-1">
                                <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1"><span>æ¸…æ½”åº¦</span><span id="hygieneValue">100%</span></div>
                                <div class="progress-bar-container h-3"><div id="hygieneFill" class="progress-fill bg-sky-500" style="width: 100%"></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 sm:gap-3 mt-4">
                        <button id="btnFeed" class="btn-action bg-blue-100 hover:bg-blue-200 text-blue-700 py-3 rounded-xl font-bold flex flex-col items-center gap-1 transition-colors"><span class="text-xl">ğŸ¥›</span><span class="text-xs">é¤µé£Ÿ</span></button>
                        <button id="btnPlay" class="btn-action bg-pink-100 hover:bg-pink-200 text-pink-700 py-3 rounded-xl font-bold flex flex-col items-center gap-1 transition-colors"><span class="text-xl">ğŸ¾</span><span class="text-xs">ç©è€</span></button>
                        <button id="btnClean" class="btn-action bg-teal-100 hover:bg-teal-200 text-teal-700 py-3 rounded-xl font-bold flex flex-col items-center gap-1 transition-colors"><span class="text-xl">ğŸš¿</span><span class="text-xs">æ¸…æ½”</span></button>
                        <button id="btnSkill" class="btn-action bg-yellow-100 hover:bg-yellow-200 text-yellow-700 py-3 rounded-xl font-bold flex flex-col items-center gap-1 transition-colors"><span class="text-xl">âš¡</span><span class="text-xs">æŠ€èƒ½</span></button>
                        <button id="btnDecor" class="btn-action bg-orange-100 hover:bg-orange-200 text-orange-700 py-3 rounded-xl font-bold flex flex-col items-center gap-1 transition-colors"><span class="text-xl">ğŸ </span><span class="text-xs">ä½ˆç½®</span></button>
                        <button id="btnShop" class="btn-action bg-purple-100 hover:bg-purple-200 text-purple-700 py-3 rounded-xl font-bold flex flex-col items-center gap-1 transition-colors"><span class="text-xl">ğŸ›ï¸</span><span class="text-xs">å•†åº—</span></button>
                        <button id="btnGame" class="btn-action col-span-2 bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold flex flex-row justify-center items-center gap-2 shadow-md transition-transform hover:-translate-y-0.5"><span class="text-xl">ğŸ®</span><span>å°éŠæˆ²</span></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modalOverlay" class="fixed inset-0 bg-black/60 hidden z-[90] items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl transform transition-all scale-100 overflow-hidden flex flex-col max-h-[90vh]">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 id="modalTitle" class="font-bold text-lg text-gray-800">æ¨™é¡Œ</h3>
                    <button id="modalClose" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div id="modalContent" class="p-4 overflow-y-auto">
                    </div>
            </div>
        </div>

        <div id="gameModal" class="fixed inset-0 bg-black/80 hidden z-[95] items-center justify-center backdrop-blur-md p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xl">ğŸ æ¥è˜‹æœå¤§ä½œæˆ°</h3>
                    <div class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">Score: <span id="gameScore" class="text-indigo-600 font-bold">0</span> | Time: <span id="gameTime" class="text-red-500 font-bold">20</span>s</div>
                </div>
                <div id="miniGameArea" class="h-80 w-full mb-4 cursor-crosshair touch-none"></div>
                <div class="flex gap-2">
                    <button id="btnStartGame" class="flex-1 bg-indigo-500 text-white py-3 rounded-xl font-bold hover:bg-indigo-600 transition-colors">é–‹å§‹ (èŠ±è²»10å¿«æ¨‚)</button>
                    <button id="btnCloseGame" class="px-6 bg-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-300">é›¢é–‹</button>
                </div>
            </div>
        </div>

        <div id="toast-container"></div>
    </div>

<script>
    /**
     * éŠæˆ²è¨­å®šèˆ‡è³‡æ–™åº«
     */
    const CONFIG = {
        maxStats: 100,
        decay: { hunger: 1.5, fun: 1.2, clean: 0.8 }, // åŸºç¤è¡°é€€ç‡
        gain: { feed: 25, play: 20, clean: 40, expAction: 15 }, // è¡Œå‹•å¢åŠ å€¼
        levelExpBase: 100, // ç­‰ç´š1æ‰€éœ€çš„ç¶“é©—å€¼
    };

    const DB = {
        pets: {
            cat: { name: 'å‚²å¬Œè²“', idle: 'ğŸ±', sad: 'ğŸ˜¿', hungry: 'ğŸ˜¼', happy: 'ğŸ˜»', color: 'from-orange-100 to-yellow-50' },
            dog: { name: 'æ†¨æ†¨ç‹—', idle: 'ğŸ¶', sad: 'ğŸ¥º', hungry: 'ğŸ•', happy: 'ğŸ¥°', color: 'from-gray-100 to-stone-50' },
            rabbit: { name: 'æœˆäº®å…”', idle: 'ğŸ°', sad: 'ğŸ˜­', hungry: 'ğŸ‡', happy: 'ğŸ¥•', color: 'from-pink-100 to-rose-50' },
            parrot: { name: 'åµé¬§é³¥', idle: 'ğŸ¦œ', sad: 'ğŸ˜', hungry: 'ğŸ¦', happy: 'ğŸ¦œ', color: 'from-green-100 to-lime-50' },
            hamster: { name: 'è²ªåƒé¼ ', idle: 'ğŸ¹', sad: 'ğŸ˜¥', hungry: 'ğŸ˜‘', happy: 'ğŸ˜‹', color: 'from-amber-100 to-orange-50' },
            turtle: { name: 'æ…¢æ´»é¾œ', idle: 'ğŸ¢', sad: 'ğŸ˜°', hungry: 'ğŸ¢', happy: 'ğŸ¥³', color: 'from-emerald-100 to-teal-50' }
        },
        items: [
            { id: 'toy', icon: 'ğŸ§¶', name: 'æ¯›ç·šçƒ', cost: 20, type: 'fun', val: 30, desc: 'å¢åŠ  30 å¿«æ¨‚' },
            { id: 'treat', icon: 'ğŸ°', name: 'é«˜ç´šç½ç½', cost: 25, type: 'hunger', val: 40, desc: 'å¢åŠ  40 é£½è¶³' },
            { id: 'soap', icon: 'ğŸ«§', name: 'æ³¡æ³¡æµ´', cost: 15, type: 'clean', val: 60, desc: 'å¢åŠ  60 æ¸…æ½”' },
            { id: 'potion', icon: 'ğŸ§ª', name: 'å…¨èƒ½è—¥æ°´', cost: 80, type: 'all', val: 50, desc: 'æ‰€æœ‰æ•¸å€¼ +50' }
        ],
        skills: [
            { id: 's1', name: 'éµèƒƒ', level: 3, desc: 'é£¢é¤“åº¦ä¸‹é™é€Ÿåº¦æ¸›ç·© 20%', type: 'passive' },
            { id: 's2', name: 'æ¨‚å¤©æ´¾', level: 5, desc: 'ç©è€æ•ˆæœæå‡ 25%', type: 'passive' },
            { id: 's3', name: 'æ½”ç™–', level: 10, desc: 'æ¸…æ½”åº¦ä¸‹é™é€Ÿåº¦æ¸›ç·© 30%', type: 'passive' },
            { id: 's4', name: 'è°æ˜çµ•é ‚', level: 15, desc: 'æ¯æ¬¡è¡Œå‹•é¡å¤–ç²å¾— 5 ç¶“é©—', type: 'passive' }
        ],
        decorations: [
            { id: 'bed', icon: 'ğŸ›ï¸', name: 'è»Ÿè»ŸåºŠ', cost: 50, style: 'bottom: 10%; left: 10%; font-size: 2.5rem;' },
            { id: 'plant', icon: 'ğŸª´', name: 'é¾œèƒŒèŠ‹', cost: 30, style: 'bottom: 15%; right: 10%; font-size: 2rem;' },
            { id: 'lamp', icon: 'ğŸ®', name: 'ç´™ç‡ˆç± ', cost: 40, style: 'top: 10%; left: 10%; font-size: 2rem;' },
            { id: 'picture', icon: 'ğŸ–¼ï¸', name: 'é¢¨æ™¯ç•«', cost: 60, style: 'top: 15%; right: 15%; font-size: 2.2rem;' }
        ]
    };

    /**
     * éŠæˆ²ç‹€æ…‹ (State)
     */
    let state = {
        petId: null,
        name: '',
        level: 1,
        exp: 0,
        gold: 100,
        stats: { hunger: 100, fun: 100, clean: 100 },
        skills: [],
        inventory: [], // æ“æœ‰çš„è£é£¾å“ ID
        lastLogin: Date.now()
    };
    
    // ç³»çµ±è®Šæ•¸
    let gameLoopId = null;
    let autoSaveId = null;
    let miniGame = { active: false, score: 0, timer: null, spawner: null };

    // DOM ç·©å­˜
    const UI = {
        panels: { select: document.getElementById('petSelectionPanel'), game: document.getElementById('gamePanel') },
        stats: {
            hunger: { text: document.getElementById('hungerValue'), bar: document.getElementById('hungerFill') },
            fun: { text: document.getElementById('happinessValue'), bar: document.getElementById('happinessFill') },
            clean: { text: document.getElementById('hygieneValue'), bar: document.getElementById('hygieneFill') },
            exp: { text: document.getElementById('expValue'), bar: document.getElementById('expFill') },
            gold: document.getElementById('goldCoinDisplay'),
            level: document.getElementById('petLevelDisplay'),
            name: document.getElementById('petNameDisplay')
        },
        pet: {
            house: document.getElementById('petHouse'),
            display: document.getElementById('petDisplay'),
            dirt: document.getElementById('dirtDisplay'),
            costume: document.getElementById('petCostume'),
            decorContainer: document.getElementById('decorationContainer'),
            floatContainer: document.getElementById('floatingTextContainer')
        },
        modal: {
            overlay: document.getElementById('modalOverlay'),
            title: document.getElementById('modalTitle'),
            content: document.getElementById('modalContent'),
            close: document.getElementById('modalClose')
        },
        gameModal: {
            overlay: document.getElementById('gameModal'),
            area: document.getElementById('miniGameArea'),
            score: document.getElementById('gameScore'),
            time: document.getElementById('gameTime'),
            start: document.getElementById('btnStartGame'),
            close: document.getElementById('btnCloseGame')
        }
    };

    /**
     * åˆå§‹åŒ–ç³»çµ±
     */
    function init() {
        renderPetSelection();
        loadGame();
        
        // ç¶å®šä¸»æŒ‰éˆ•äº‹ä»¶
        document.getElementById('btnFeed').onclick = () => action('feed');
        document.getElementById('btnPlay').onclick = () => action('play');
        document.getElementById('btnClean').onclick = () => action('clean');
        document.getElementById('btnShop').onclick = openShop;
        document.getElementById('btnSkill').onclick = openSkills;
        document.getElementById('btnDecor').onclick = openDecor;
        document.getElementById('btnGame').onclick = openMiniGameModal;
        
        // Modal é—œé–‰
        UI.modal.close.onclick = closeModal;
        UI.modal.overlay.onclick = (e) => { if(e.target === UI.modal.overlay) closeModal(); };
        
        // é‡ç½®æŒ‰éˆ•
        document.getElementById('resetSaveBtn').onclick = () => {
            if(confirm('ç¢ºå®šè¦åˆªé™¤å­˜æª”é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
                localStorage.removeItem('petSaveData');
                location.reload();
            }
        };

        // è‡ªå‹•å­˜æª”å¾ªç’°
        autoSaveId = setInterval(saveGame, 5000);
    }

    /**
     * æ ¸å¿ƒé‚è¼¯
     */
    function loadGame() {
        const saved = localStorage.getItem('petSaveData');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // åˆä½µå­˜æª”ï¼Œé¿å…èˆŠç‰ˆå­˜æª”ç¼ºå°‘æ¬„ä½
                state = { ...state, ...parsed, stats: { ...state.stats, ...parsed.stats } };
                
                // è¨ˆç®—é›¢ç·šæ™‚é–“çš„æ•¸å€¼æ‰£é™¤ (ç°¡æ˜“ç‰ˆ)
                const now = Date.now();
                const diffHours = (now - state.lastLogin) / (1000 * 60 * 60);
                if (diffHours > 0.5) {
                    showToast(`ä½ é›¢é–‹äº† ${diffHours.toFixed(1)} å°æ™‚ï¼Œå¯µç‰©æƒ³ä½ äº†ï¼`);
                    updateStats({ hunger: -diffHours * 10, fun: -diffHours * 10, clean: -diffHours * 5 });
                }

                startGame(state.petId);
            } catch (e) {
                console.error("å­˜æª”æå£", e);
                localStorage.removeItem('petSaveData');
            }
        }
    }

    function saveGame() {
        if (!state.petId) return;
        state.lastLogin = Date.now();
        localStorage.setItem('petSaveData', JSON.stringify(state));
        const btn = document.getElementById('saveBtn');
        btn.textContent = 'å·²å­˜æª”';
        setTimeout(() => btn.textContent = 'è‡ªå‹•å­˜æª”ä¸­...', 2000);
    }

    function startGame(petId) {
        state.petId = petId;
        UI.panels.select.classList.add('hidden');
        UI.panels.game.classList.remove('hidden');
        
        // è¨­å®šå¯µç‰©åŸºæœ¬è³‡æ–™
        const petData = DB.pets[petId];
        UI.stats.name.textContent = petData.name;
        
        renderDecorations();
        updateUI();
        
        // é–‹å§‹éŠæˆ²å¾ªç’° (æ¯ç§’æ‰£æ•¸å€¼)
        if (gameLoopId) clearInterval(gameLoopId);
        gameLoopId = setInterval(gameLoop, 1000);
    }

    function gameLoop() {
        // è¨ˆç®—æŠ€èƒ½æ¸›å…
        let decay = { ...CONFIG.decay };
        if (hasSkill('s1')) decay.hunger *= 0.8;
        if (hasSkill('s3')) decay.clean *= 0.7;

        updateStats({
            hunger: -decay.hunger,
            fun: -decay.fun,
            clean: -decay.clean
        }, false); // false = ä¸é¡¯ç¤ºæµ®å‹•æ–‡å­—
        
        // æª¢æŸ¥ç‰¹æ®Šç¯€æ—¥
        checkHoliday();
    }

    /**
     * å‹•ä½œç³»çµ±
     */
    function action(type) {
        if (state.stats.hunger <= 0 && type !== 'feed') return showToast('å¯µç‰©é¤“æ‰äº†ï¼Œæ²’åŠ›æ°£ï¼');
        
        UI.pet.display.classList.add('animate-pop');
        setTimeout(() => UI.pet.display.classList.remove('animate-pop'), 300);

        let changes = {};
        let gainExp = CONFIG.gain.expAction + (hasSkill('s4') ? 5 : 0);
        let msg = '';

        if (type === 'feed') {
            changes = { hunger: CONFIG.gain.feed };
            msg = 'Yummy!';
            createFloatingText('ğŸ +é£½è¶³', 'text-green-600');
        } else if (type === 'play') {
            let val = CONFIG.gain.play * (hasSkill('s2') ? 1.25 : 1);
            changes = { fun: val, hunger: -5 };
            msg = 'Happy!';
            createFloatingText('ğŸ¾ +å¿«æ¨‚', 'text-pink-600');
        } else if (type === 'clean') {
            changes = { clean: CONFIG.gain.clean };
            msg = 'Shiny!';
            createFloatingText('âœ¨ +æ¸…æ½”', 'text-blue-600');
        }

        updateStats(changes);
        addExp(gainExp);
        addGold(Math.floor(Math.random() * 5) + 1); // éš¨æ©Ÿç²å¾—é‡‘å¹£
    }

    function updateStats(changes, showFloat = true) {
        for (let key in changes) {
            state.stats[key] = Math.min(CONFIG.maxStats, Math.max(0, state.stats[key] + changes[key]));
        }
        updateUI();
    }

    function updateUI() {
        const pet = DB.pets[state.petId];
        const s = state.stats;

        // æ›´æ–°é€²åº¦æ¢
        updateBar(UI.stats.hunger, s.hunger, 'bg-green-500', 'bg-red-500');
        updateBar(UI.stats.fun, s.fun, 'bg-pink-500', 'bg-purple-500');
        updateBar(UI.stats.clean, s.clean, 'bg-sky-500', 'bg-gray-500');

        UI.stats.exp.text.textContent = `${Math.floor(state.exp)}/${getExpMax()}`;
        UI.stats.exp.bar.style.width = `${(state.exp / getExpMax()) * 100}%`;
        UI.stats.level.textContent = `Lv.${state.level}`;
        UI.stats.gold.textContent = state.gold;

        // æ›´æ–°å¯µç‰©è¡¨æƒ…
        let mood = pet.idle;
        if (s.clean < 30) { mood = pet.sad; UI.pet.dirt.classList.remove('hidden'); }
        else {
            UI.pet.dirt.classList.add('hidden');
            if (s.hunger < 30) mood = pet.hungry;
            else if (s.fun > 80) mood = pet.happy;
            else if (s.fun < 30) mood = pet.sad;
        }
        UI.pet.display.textContent = mood;
    }

    function updateBar(el, val, highColor, lowColor) {
        el.text.textContent = `${Math.round(val)}%`;
        el.bar.style.width = `${val}%`;
        el.bar.className = `progress-fill ${val > 30 ? highColor : lowColor}`;
    }

    /**
     * ç­‰ç´šèˆ‡ç¶“æ¿Ÿç³»çµ±
     */
    function getExpMax() { return state.level * CONFIG.levelExpBase; }

    function addExp(amount) {
        state.exp += amount;
        if (state.exp >= getExpMax()) {
            state.exp -= getExpMax();
            state.level++;
            state.gold += state.level * 20; // å‡ç´šçå‹µ
            showToast(`å‡ç´šäº†ï¼é”åˆ° Lv.${state.level}ï¼Œç²å¾—çå‹µé‡‘å¹£ï¼`);
            createFloatingText('ğŸ†™ LEVEL UP', 'text-yellow-500 text-2xl');
            
            // æª¢æŸ¥è§£é–æŠ€èƒ½
            DB.skills.forEach(skill => {
                if (state.level === skill.level) showToast(`æ–°æŠ€èƒ½è§£é–ï¼š${skill.name}ï¼`);
            });
        }
    }

    function addGold(amount) {
        state.gold += amount;
        UI.stats.gold.textContent = state.gold;
    }

    function hasSkill(id) {
        // ç°¡å–®åˆ¤å®šï¼šåªè¦ç­‰ç´šåˆ°äº†å°±è‡ªå‹•æ“æœ‰è¢«å‹•æŠ€
        const skill = DB.skills.find(s => s.id === id);
        return skill && state.level >= skill.level;
    }

    /**
     * å•†åº—èˆ‡ç‰©å“ç³»çµ±
     */
    function openShop() {
        let html = `<div class="grid grid-cols-2 gap-3">`;
        DB.items.forEach(item => {
            html += `
                <div onclick="buyItem('${item.id}')" class="border p-3 rounded-xl cursor-pointer hover:bg-indigo-50 transition active:scale-95 flex flex-col items-center text-center">
                    <div class="text-3xl mb-1">${item.icon}</div>
                    <div class="font-bold text-sm">${item.name}</div>
                    <div class="text-xs text-gray-500 mb-1">${item.desc}</div>
                    <div class="text-amber-500 font-bold text-sm">ğŸ’° ${item.cost}</div>
                </div>
            `;
        });
        html += `</div>`;
        openModal('ä¾¿åˆ©å•†åº—', html);
    }

    window.buyItem = function(itemId) {
        const item = DB.items.find(i => i.id === itemId);
        if (state.gold >= item.cost) {
            state.gold -= item.cost;
            let changes = {};
            if (item.type === 'all') changes = { hunger: item.val, fun: item.val, clean: item.val };
            else changes[item.type] = item.val;
            
            updateStats(changes);
            updateUI();
            showToast(`è³¼è²·ä¸¦ä½¿ç”¨äº† ${item.name}`);
            closeModal();
        } else {
            showToast('é‡‘å¹£ä¸è¶³ï¼å¿«å»ç©å°éŠæˆ²è³ºéŒ¢å§ï¼');
        }
    };

    /**
     * è£é£¾ç³»çµ±
     */
    function openDecor() {
        let html = `<div class="grid grid-cols-2 gap-3">`;
        DB.decorations.forEach(d => {
            const owned = state.inventory.includes(d.id);
            html += `
                <div onclick="${owned ? '' : `buyDecor('${d.id}')`}" class="border p-3 rounded-xl ${owned ? 'bg-gray-100 opacity-60' : 'cursor-pointer hover:bg-orange-50'} transition flex flex-col items-center text-center">
                    <div class="text-3xl mb-1">${d.icon}</div>
                    <div class="font-bold text-sm">${d.name}</div>
                    <div class="text-amber-500 font-bold text-sm">${owned ? 'å·²æ“æœ‰' : `ğŸ’° ${d.cost}`}</div>
                </div>
            `;
        });
        html += `</div>`;
        openModal('å®¶å…·è¡Œ', html);
    }

    window.buyDecor = function(id) {
        const item = DB.decorations.find(d => d.id === id);
        if (state.gold >= item.cost) {
            state.gold -= item.cost;
            state.inventory.push(id);
            renderDecorations();
            updateUI();
            showToast(`è³¼å…¥äº† ${item.name}ï¼`);
            openDecor(); // åˆ·æ–°ä»‹é¢
        } else {
            showToast('éŒ¢ä¸å¤ è²·é€™å€‹å®¶å…·QQ');
        }
    }

    function renderDecorations() {
        UI.pet.decorContainer.innerHTML = '';
        state.inventory.forEach(id => {
            const item = DB.decorations.find(d => d.id === id);
            if (item) {
                const el = document.createElement('div');
                el.textContent = item.icon;
                el.style.cssText = `position: absolute; ${item.style}`;
                UI.pet.decorContainer.appendChild(el);
            }
        });
    }

    function openSkills() {
        let html = `<div class="space-y-2">`;
        DB.skills.forEach(s => {
            const unlocked = state.level >= s.level;
            html += `
                <div class="flex items-center p-3 rounded-lg ${unlocked ? 'bg-green-50 border border-green-200' : 'bg-gray-100 opacity-50'}">
                    <div class="text-2xl mr-3">${unlocked ? 'âœ…' : 'ğŸ”’'}</div>
                    <div>
                        <div class="font-bold text-gray-800">${s.name} <span class="text-xs text-gray-500">(Lv.${s.level})</span></div>
                        <div class="text-xs text-gray-600">${s.desc}</div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        openModal('æŠ€èƒ½æ¨¹', html);
    }

    /**
     * å°éŠæˆ²ï¼šæ¥è˜‹æœ
     */
    function openMiniGameModal() {
        UI.gameModal.overlay.classList.remove('hidden');
        UI.gameModal.overlay.classList.add('flex');
        UI.gameModal.start.onclick = startMiniGame;
        UI.gameModal.close.onclick = () => {
            stopMiniGame();
            UI.gameModal.overlay.classList.add('hidden');
            UI.gameModal.overlay.classList.remove('flex');
        };
    }

    function startMiniGame() {
        if (state.stats.fun < 10) { showToast('å¯µç‰©å¤ªä¸é–‹å¿ƒäº†ï¼Œä¸æƒ³ç©ï¼'); return; }
        
        updateStats({ fun: -10 }); // æ‰£å…¥å ´è²»
        miniGame.active = true;
        miniGame.score = 0;
        UI.gameModal.score.textContent = 0;
        UI.gameModal.start.disabled = true;
        UI.gameModal.start.classList.add('opacity-50');
        
        let timeLeft = 20;
        UI.gameModal.time.textContent = timeLeft;
        UI.gameModal.area.innerHTML = ''; // æ¸…ç©º

        // è¨ˆæ™‚å™¨
        miniGame.timer = setInterval(() => {
            timeLeft--;
            UI.gameModal.time.textContent = timeLeft;
            if (timeLeft <= 0) endMiniGame();
        }, 1000);

        // ç”Ÿæˆå™¨
        spawnItem();
    }

    function spawnItem() {
        if (!miniGame.active) return;
        
        const el = document.createElement('div');
        const isBomb = Math.random() < 0.3;
        el.textContent = isBomb ? 'ğŸ’£' : 'ğŸ';
        el.className = 'falling-item select-none';
        el.style.left = Math.random() * 85 + '%';
        el.style.top = '-50px';
        
        UI.gameModal.area.appendChild(el);

        let pos = -50;
        const speed = 3 + Math.random() * 3; // éš¨æ©Ÿé€Ÿåº¦

        function fall() {
            if (!miniGame.active || !el.parentNode) return;
            pos += speed;
            el.style.transform = `translateY(${pos}px)`;
            
            // é»æ“Šåˆ¤å®š
            el.onpointerdown = (e) => {
                e.stopPropagation();
                if (isBomb) {
                    miniGame.score = Math.max(0, miniGame.score - 5);
                    createFloatingText('-5', 'text-red-500 font-bold', el);
                } else {
                    miniGame.score += 1;
                    createFloatingText('+1', 'text-green-500 font-bold', el);
                }
                UI.gameModal.score.textContent = miniGame.score;
                el.remove();
            };

            // è¶…å‡ºé‚Šç•Œç§»é™¤
            if (pos > 320) el.remove();
            else requestAnimationFrame(fall);
        }
        requestAnimationFrame(fall);

        // å¾ªç’°ç”Ÿæˆ (é€Ÿåº¦éš¨åˆ†æ•¸åŠ å¿«)
        const nextSpawn = Math.max(400, 1000 - miniGame.score * 20);
        miniGame.spawner = setTimeout(spawnItem, nextSpawn);
    }

    function stopMiniGame() {
        miniGame.active = false;
        clearInterval(miniGame.timer);
        clearTimeout(miniGame.spawner);
        UI.gameModal.start.disabled = false;
        UI.gameModal.start.classList.remove('opacity-50');
    }

    function endMiniGame() {
        stopMiniGame();
        const goldReward = miniGame.score * 2;
        const expReward = miniGame.score * 3;
        addGold(goldReward);
        addExp(expReward);
        showToast(`éŠæˆ²çµæŸï¼ç²å¾— ${goldReward} é‡‘å¹£ & ${expReward} ç¶“é©—ï¼`);
        UI.gameModal.area.innerHTML = `<div class="flex h-full items-center justify-center text-2xl font-bold text-gray-400">Time's Up!</div>`;
    }

    /**
     * è¼”åŠ©åŠŸèƒ½
     */
    function renderPetSelection() {
        const grid = document.getElementById('petSelectGrid');
        for (let key in DB.pets) {
            const p = DB.pets[key];
            const btn = document.createElement('button');
            btn.className = `p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:scale-105 transition bg-gradient-to-br ${p.color}`;
            btn.innerHTML = `<div class="text-5xl mb-2">${p.idle}</div><div class="font-bold text-gray-700">${p.name}</div>`;
            btn.onclick = () => {
                // å­˜åˆå§‹æª”
                state.petId = key;
                saveGame();
                startGame(key);
            };
            grid.appendChild(btn);
        }
    }

    function openModal(title, contentHTML) {
        UI.modal.title.textContent = title;
        UI.modal.content.innerHTML = contentHTML;
        UI.modal.overlay.classList.remove('hidden');
        UI.modal.overlay.classList.add('flex');
    }

    function closeModal() {
        UI.modal.overlay.classList.add('hidden');
        UI.modal.overlay.classList.remove('flex');
    }

    function showToast(msg) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function createFloatingText(text, className, targetEl = null) {
        const el = document.createElement('div');
        el.className = `float-text ${className}`;
        el.textContent = text;
        
        // æ±ºå®šä½ç½®ï¼šå¦‚æœæœ‰æŒ‡å®šç›®æ¨™(å¦‚å°éŠæˆ²è˜‹æœ)å‰‡åœ¨ç›®æ¨™è™•ï¼Œå¦å‰‡åœ¨å¯µç‰©é ­ä¸Š
        if (targetEl) {
            const rect = targetEl.getBoundingClientRect();
            const areaRect = UI.gameModal.area.getBoundingClientRect();
            el.style.left = (rect.left - areaRect.left + 10) + 'px';
            el.style.top = (rect.top - areaRect.top) + 'px';
            UI.gameModal.area.appendChild(el);
        } else {
            el.style.left = '50%';
            el.style.top = '40%';
            el.style.transform = 'translate(-50%, -50%)';
            UI.pet.floatContainer.appendChild(el);
        }
        
        setTimeout(() => el.remove(), 1500);
    }

    function checkHoliday() {
        const d = new Date();
        const m = d.getMonth() + 1;
        const day = d.getDate();
        let decor = '';
        if (m === 12 && day === 25) decor = 'ğŸ…';
        else if (m === 10 && day === 31) decor = 'ğŸƒ';
        else if (m === 1 && day === 1) decor = 'ğŸ§§';
        
        UI.pet.costume.textContent = decor;
        if(decor && Math.random() < 0.01) showToast('ç¯€æ—¥å¿«æ¨‚ï¼');
    }

    // å•Ÿå‹•
    init();

</script>
</body>
</html>